<!DOCTYPE html>
<html lang="he" dir="rtl">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>Booking Assistant | BoostMind</title>
  <link href="https://fonts.googleapis.com/css2?family=Heebo:wght@300;500;700&display=swap" rel="stylesheet" />
  <style>
    html,
    body {
      margin: 0;
      padding: 0;
      height: 100%;
    }

    body {
      font-family: 'Heebo', sans-serif;
      background: #0e0f13;
      color: #eaeef5;
    }

    .app {
      display: flex;
      flex-direction: column;
      height: 100dvh;
      /* dynamic height to avoid iOS keyboard push */
    }

    header {
      background: #151823;
      padding: 16px 24px;
      font-size: 20px;
      font-weight: 700;
      border-bottom: 1px solid #222;
      text-align: center;
      flex-shrink: 0;
    }

    .chat-container {
      flex: 1;
      display: flex;
      flex-direction: column;
      padding: 16px;
      overflow-y: auto;
      scroll-behavior: smooth;
    }

    .message {
      max-width: 80%;
      padding: 12px 16px;
      margin: 8px 0;
      border-radius: 16px;
      font-size: 16px;
      line-height: 1.5;
    }

    .bot {
      background: #1c1f2b;
      align-self: flex-start;
      border: 1px solid #333;
    }

    .user {
      background: #46d16f;
      color: #0e0f13;
      align-self: flex-end;
    }

    form {
      display: flex;
      border-top: 1px solid #222;
      background: #151823;
      flex-shrink: 0;
    }

    input[type="text"] {
      flex: 1;
      font-size: 16px;
      padding: 16px;
      border: none;
      background: #0e0f13;
      color: #fff;
    }

    button {
      background: #46d16f;
      color: #0e0f13;
      border: none;
      padding: 16px 24px;
      font-weight: bold;
      cursor: pointer;
      transition: background 0.2s;
    }

    button:hover {
      background: #3abc61;
    }

    @media (max-width: 600px) {
      .message {
        max-width: 95%;
        font-size: 15px;
      }

      input[type="text"],
      button {
        padding: 14px;
      }
    }

    .typing-dots {
      display: inline-flex;
      gap: 4px;
      font-size: 24px;
      line-height: 0;
    }

    .typing-dots span {
      animation: blink 1.2s infinite ease-in-out;
      animation-delay: calc(var(--i) * 0.2s);
      opacity: 0.2;
    }

    .typing-dots span:nth-child(1) {
      --i: 0;
    }

    .typing-dots span:nth-child(2) {
      --i: 1;
    }

    .typing-dots span:nth-child(3) {
      --i: 2;
    }

    @keyframes blink {

      0%,
      80%,
      100% {
        opacity: 0.2;
      }

      40% {
        opacity: 1;
      }
    }
  </style>
</head>

<body>

  <div class="app">
    <header>🤖 סוכן ההזמנות החכם של BoostMind</header>

    <div class="chat-container" id="chat">
      <div class="message bot">
        היי, איך אפשר לעזור לך היום?
      </div>
    </div>

    <form id="chat-form">
      <input type="text" id="user-input" placeholder="כתוב כאן את ההודעה שלך..." autocomplete="off" required />
      <button type="submit">שלח</button>
    </form>
  </div>

  <script>
    const chatContainer = document.getElementById('chat');
    const form = document.getElementById('chat-form');
    const input = document.getElementById('user-input');

    const conversationId = localStorage.getItem('booking_conversation_id') || crypto.randomUUID();
    localStorage.setItem('booking_conversation_id', conversationId);

    let loadingMessageEl = null;

    const addMessage = (text, sender = 'bot') => {
      const msg = document.createElement('div');
      msg.classList.add('message', sender);
      msg.innerText = text;
      chatContainer.appendChild(msg);
      chatContainer.scrollTop = chatContainer.scrollHeight;
      return msg;
    };

    const showTypingIndicator = () => {
      loadingMessageEl = document.createElement('div');
      loadingMessageEl.classList.add('message', 'bot');
      loadingMessageEl.innerHTML = '<span class="typing-dots"><span>.</span><span>.</span><span>.</span></span>';
      chatContainer.appendChild(loadingMessageEl);
      chatContainer.scrollTop = chatContainer.scrollHeight;
    };

    const removeTypingIndicator = () => {
      if (loadingMessageEl) {
        chatContainer.removeChild(loadingMessageEl);
        loadingMessageEl = null;
      }
    };

    form.addEventListener('submit', async (e) => {
      e.preventDefault();
      const userText = input.value.trim();
      if (!userText) return;

      addMessage(userText, 'user');
      input.value = '';
      showTypingIndicator();

      try {
        const res = await fetch('https://conquer-game-server.lm.r.appspot.com/api/booking-assistant', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            message: userText,
            conversationId: conversationId
          })
        });

        const data = await res.json();
        removeTypingIndicator();
        addMessage(data.reply, 'bot');
      } catch (err) {
        removeTypingIndicator();
        addMessage("מצטער, הייתה שגיאה בתקשורת.", 'bot');
      }
    });
  </script>
</body>

</html>